## 스레드

스레드 : CPU 이용의 기본 단위, 스레드 ID, 프로그램 카운터, 레지스터 집합, 스택으로 구성

스레드는 같은 프로세스에 속한 다른 **스레드와 코드, 데이터 섹션, 열린 파일이나 신호**와 같은 **운영체제 자원 공유**



#### 다중 스레드 프로그래밍의 장점

- **응답성** : 대화형 응용을 다중 스레드화하면 응용 프로그램의 일부분이 봉쇄되거나, 또는 응용 프로그램이 **긴 작업을 수행하더라도 프로그램이 계속되는 것을 허용**함으로써, 사용자에 대한 응답성을 증가시킨다.
- **자원공유** : **스레드는 자동적으로 그들이 속한 프로세스의 자원들과 메모리를 공유**한다. 코드와 데이터 공유의 이점은 한 응용 프로그램이 같은 주소 공간 내에 여러 개의 다른 작업을 하는 스레드를 가질 수 있다는 점.
- **경제성** : 프로세스 생성을 위해 메모리와 자원을 할당하는 것은 비용이 많이 듬. **스레드는 자신이 속한 프로세스의 자원들을 공유하기 때문에, 스레드를 생성하고 문맥 교환하는 것이 보다 더 경제적**.
- **규모 적응성** : 다중 스레드의 이점은 다중 처리기 구조에서 더욱 증가한다. 다중 처리기 구조에서는 각각의 스레드가 다른 처리기에서 병렬로 수행 될 수 있기 때문.



### 다중 스레드 모델

#### 다대일 모델

**많은 사용자 수준 스레드를 하나의 커널 스레드**로 사상함. 한 **스레드가 봉쇄형 시스템 콜을 할 경우, 전체 프로세스가 봉쇄**되어 이 모델을 사용 중인 시스템은 거의 존재하지 않는다.



#### 일대일 모델

**각 사용자 스레드를 각각 하나의 커널 스레드**로 사상한다. 단점으로는 사용자 수준 스레드를 생성할 때, 그에 따른 **커널 스레드를 생성하며 오버헤드가 응용 프로그램의 성능을 저하**시킨다. 이 모델의 대부분 구현은 시스템에 의해 지원되는 **스레드의 수를 제한**한다. Windows 계열의 운영체제들과 Linux가 일대일 모델을 구현하고 있다.



#### 다대다 모델

**여러 개의 사용자 수준 스레드를 그보다 작은 수 혹은, 같은 수의 커널 스레드로 멀티플렉스** 함.

다대다 모델의 변형으로 **두 수준 모델**도 있다.



### 스레드 라이브러리

스레드 라이브러리는 프로그래머에게 스레드를 생성하고 관리하기 위한 API를 제공한다.

**비동기 스레딩** : 부모가 자식 스레드를 생성한 후 부모는 자신의 실행을 재개하여 부모와 자식 스레드가 병행하게 실행된다. 스레드가 독립적이기 때문에 스레드 사이의 데이터 공유는 거의 없다.

**동기 스레딩** :  부모 스레드가 하나 이상의 자식 스레드를 생성하고 자식 스레드 모두가 종료할 때까지 기다렸다가 자신의 실행을 재개하는 방식 => 포크-조인 전략



#### 스레드 풀

스레드 풀은 프로세스를 시작할 때 아예 **일정한 수의 스레드들을 미리풀**로 만들어 두는 것이다. 평소에는 하는 일 없이 일감을 기다리다 한개의 요청이 들어오면 이 풀에서 한 스레드에게 그것을 할당한다. 요청을 다 서비스해 주었으면 다시 풀로 돌아가 다음 작업을 기다린다. **풀에 남아 있는 스레드가 바닥**나면 서버는 **가용 스레드가 생길 때까지 기다린다.**



**장점**

1. 새 스레드를 만들어 주기보다 기존 스레드로 서비스해 주는 것이 더 빠름
2. 스레드 풀은 임의 시각에 존재할 스레드 개수에 제한을 둠. 이러한 제한은 많은 수의 스레드를 병렬 처리할 수 없는 시스템에 도움이 됨
3. 태스크를 생성하는 방법을 테스크로부터 분리하면 태스크를 실행을 다르게 할 수 있다. 예를 들어 태스크를 일정 시간 후에 실행되도록 스케줄하거나 혹은 주기적으로 실행시킬 수 있다.



#### 취소

스레드 취소는 스레드가 끝나기 전에 그것을 강제 종료시키는 작업을 일컫는다. 예를 들어 DB를 병렬로 검색하다 한 스레드가 결과를 찾았다면 나머지 스레드들은 취소되어도 된다. 이처럼 취소되어야 할 스레드를 **목적 스레드**(target thread)라고 부른다.

1. 비동기식 취소 : 한 스레드가 즉식 목적 스레드를 강제 종료 시킨다.
2. 지연 취소 : 목적 스레드가 주기적으로 자신이 종료되어야 할지를 점검한다.



#### 스레드 국지 저장소(Thread-Local Storage)

한 프로세스에 속한 스레드들은 그 프로세서의 데이터를 모두 공유한다. 데이터 공유는 다중 스레드 프로그래밍의 큰 장점이지만, 상황에 따라서는 각 스레드가 자기만 액세스 할 수 있는 데이터를 가져야 되는데 이런것을 TLS라 한다. 예를 들어 트랜잭션 처리 시스템에서 각 트랜잭션을 독립된 스레드가 처리해 준다고 가정하면 각 트랜잭션은 고유한 식별자가 주어지고 이 때, 각 스레드마다 고유한 식별자를 연관시키기 위해서는 TLS가 있어야만 한다.



